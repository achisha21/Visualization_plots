---
title: "DESeq2 of both upreg and downreg all groups"
author: "Achisha Saikia"
date: "`r Sys.Date()`"
output: html_document
---


```{r error=FALSE, warning=FALSE, message=FALSE}

setwd("/Volumes/project-8/bioinformatics/JLee_lab/s224730/Marek/shRNA_18_samples_Human_aug2023/outputs/readCounts/Deseq2_without_C1/Analysis_1.4_9.4/Pathways")

library(DESeq2)
library(edgeR)
library(pheatmap)
library(RColorBrewer)
library(ggplot2)
library(gplots)
library(gridExtra)
library("biomaRt")
library(corrplot)
library(ggrepel)
library("plotly")#, lib.loc="~/R/win-library/3.5")
library(biomaRt)
library(knitr)
library(VennDiagram)
library(ggpubr)
library(limma)
library(reshape2)
library(readxl)
library(kableExtra)
library(EnhancedVolcano)
library(tidyverse)

Data <- read.csv("readCount.tsv",
                header = TRUE, 
                sep = '\t',
                skip=1)

rownames(Data) <- Data$Geneid
#View(Data)

colnames(Data) <- c("Geneid","Chr","Start","End","Strand","Length","C1_FXNSH2","C1_FXNSH3","C1_Novirus","C1_SCR","C2_FXNSH2","C2_FXNSH3", "C2_Novirus", "C2_SCR", "C3_FXNSH2", "C3_FXNSH3", "C3_Novirus", "C3_SCR", "F1_Novirus", "F1_SCR", "F2_Novirus", "F2_SCR", "F3_Novirus", "F3_SCR")

##=== countData
countData <- as.matrix(Data[,-c(1:10)])
mode(countData) <- "integer"


colData <- read.csv("info1.csv", sep=",", row.names=1)

#View(countData)
#View(colData)

GeneID_table <- Data[,c(1:6)]

#View(GeneID_table)
##===Generate a Gene Symbol to Ensembl/Entrez ID conversion table
#ensembl = useMart("ensembl",dataset="hsapiens_gene_ensembl")
#Symbol_table <- getBM(attributes=c("hgnc_symbol","ensembl_gene_id","entrezgene_id"), filters = 'hgnc_symbol', values = rownames(GeneID_table), mart = ensembl)
#write.table(Symbol_table, file="Symbol_table.txt", quote=FALSE, sep="\t")
```



Data preprocessing, filtering, and normalization

```{r}
##===Check all sample IDs in colData are also in CountData and match their orders
all(rownames(colData) %in% colnames(countData))
```

```{r}
countData <- countData[, rownames(colData)]
all(rownames(colData) == colnames(countData))
```


```{r error=FALSE, warning=FALSE, message=FALSE}
dds <- DESeqDataSetFromMatrix(countData = countData, colData = colData, design= ~ Groups)
dds <- DESeq(dds, test = "Wald")
```

Groups: Patient vs Control, F.SCR vs C.SCR, FXNsh2 vs C.SCR, FXNsh3 vs C.SCR, FXNsh2 vs FXNsh3, FXNsh2 vs F.SCR, FXNsh3 vs F.SCR, FXNsh vs F.SCR, FXNsh vs C.SCR


I) Group1: Patient vs Control
```{r}
### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_Patient_vs_Control <- results(dds, contrast = c("Groups", "Patient", "Control"), pAdjustMethod = "BH")
res_Patient_vs_Control <- res_Patient_vs_Control[order(res_Patient_vs_Control$pvalue),]

res_Patient_vs_Control_tb <- res_Patient_vs_Control %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_Patient_vs_Control <- res_Patient_vs_Control_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

#ALL_Patient_vs_Control
```
Group 2: F.SCR vs C.SCR

```{r}
### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_F.SCR_vs_C.SCR <- results(dds, contrast = c("Groups", "F.SCR", "C.SCR"), pAdjustMethod = "BH")
res_F.SCR_vs_C.SCR <- res_F.SCR_vs_C.SCR[order(res_F.SCR_vs_C.SCR$pvalue),]

res_F.SCR_vs_C.SCR_tb <- res_F.SCR_vs_C.SCR %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_F.SCR_vs_C.SCR <- res_F.SCR_vs_C.SCR_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_F.SCR_vs_C.SCR
```

Group 3: FXNsh2 vs C.SCR

```{r}
### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_FXNsh2_vs_C.SCR <- results(dds, contrast = c("Groups", "FXNsh2", "C.SCR"), pAdjustMethod = "BH")
res_FXNsh2_vs_C.SCR <- res_FXNsh2_vs_C.SCR[order(res_FXNsh2_vs_C.SCR$pvalue),]

res_FXNsh2_vs_C.SCR_tb <- res_FXNsh2_vs_C.SCR %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_FXNsh2_vs_C.SCR <- res_FXNsh2_vs_C.SCR_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_FXNsh2_vs_C.SCR
```

Group 4: FXNsh3 vs C.SCR

```{r}
### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_FXNsh3_vs_C.SCR <- results(dds, contrast = c("Groups", "FXNsh3", "C.SCR"), pAdjustMethod = "BH")
res_FXNsh3_vs_C.SCR <- res_FXNsh3_vs_C.SCR[order(res_FXNsh3_vs_C.SCR$pvalue),]

res_FXNsh3_vs_C.SCR_tb <- res_FXNsh3_vs_C.SCR %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_FXNsh3_vs_C.SCR<- res_FXNsh3_vs_C.SCR_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_FXNsh3_vs_C.SCR
```

Group 5: Fxnsh2 vs Fxnsh3

```{r}

### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_FXNsh2_vs_FXNsh3 <- results(dds, contrast = c("Groups", "FXNsh2", "FXNsh3"), pAdjustMethod = "BH")
res_FXNsh2_vs_FXNsh3  <- res_FXNsh2_vs_FXNsh3 [order(res_FXNsh2_vs_FXNsh3$pvalue),]

res_FXNsh2_vs_FXNsh3_tb <- res_FXNsh2_vs_FXNsh3 %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_FXNsh2_vs_FXNsh3 <- res_FXNsh2_vs_FXNsh3_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_FXNsh2_vs_FXNsh3 
```

Group 6: Fxnsh2 vs F.SCR

```{r}
### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_FXNsh2_vs_F.SCR <- results(dds, contrast = c("Groups", "FXNsh2", "F.SCR"), pAdjustMethod = "BH")
res_FXNsh2_vs_F.SCR <- res_FXNsh2_vs_F.SCR[order(res_FXNsh2_vs_F.SCR$pvalue),]

res_FXNsh2_vs_F.SCR_tb <- res_FXNsh2_vs_F.SCR %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_FXNsh2_vs_F.SCR <- res_FXNsh2_vs_F.SCR_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_FXNsh2_vs_F.SCR
```

Group 7: Fxnsh3 vs F.SCR

```{r}
### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_FXNsh3_vs_F.SCR <- results(dds, contrast = c("Groups", "FXNsh3", "F.SCR"), pAdjustMethod = "BH")
res_FXNsh3_vs_F.SCR <- res_FXNsh3_vs_F.SCR[order(res_FXNsh3_vs_F.SCR$pvalue),]

res_FXNsh3_vs_F.SCR_tb <- res_FXNsh3_vs_F.SCR %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_FXNsh3_vs_F.SCR<- res_FXNsh3_vs_F.SCR_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_FXNsh3_vs_F.SCR
```

DESeq Analyses
```{r error=FALSE, warning=FALSE, message=FALSE}
dds <- DESeqDataSetFromMatrix(countData = countData, colData = colData, design= ~ Group1)
dds <- DESeq(dds, test = "Wald")
```


Group 8: FXNsh vs F.SCR

```{r}
### Set thresholds
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_FXNsh_vs_F.SCR <- results(dds, contrast = c("Group1", "FXNsh", "F.SCR"), pAdjustMethod = "BH")
res_FXNsh_vs_F.SCR <- res_FXNsh_vs_F.SCR[order(res_FXNsh_vs_F.SCR$pvalue),]

res_FXNsh_vs_F.SCR_tb <- res_FXNsh_vs_F.SCR %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_FXNsh_vs_F.SCR<- res_FXNsh_vs_F.SCR_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_FXNsh_vs_F.SCR
```

Group9: FXNsh vs C.SCR

```{r}
pvalue.cutoff <- 0.05
lfc.cutoff <- 1

res_FXNsh_vs_C.SCR <- results(dds, contrast = c("Group1", "FXNsh", "C.SCR"), pAdjustMethod = "BH")
res_FXNsh_vs_C.SCR <- res_FXNsh_vs_C.SCR[order(res_FXNsh_vs_C.SCR$pvalue),]

res_FXNsh_vs_C.SCR_tb <- res_FXNsh_vs_C.SCR %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble()

ALL_FXNsh_vs_C.SCR <- res_FXNsh_vs_C.SCR_tb %>%
        dplyr::filter(pvalue < pvalue.cutoff & abs(log2FoldChange) > lfc.cutoff)

ALL_FXNsh_vs_C.SCR

```


UPSET PLOT
ALL_Patient_vs_Control
ALL_F.SCR_vs_C.SCR
ALL_FXNsh2_vs_C.SCR
ALL_FXNsh3_vs_C.SCR
ALL_FXNsh2_vs_FXNsh3
ALL_FXNsh2_vs_F.SCR
ALL_FXNsh3_vs_F.SCR
ALL_FXNsh_vs_F.SCR
ALL_FXNsh_vs_C.SCR

```{r}
# Assuming you have dataframes like df1, df2, ..., df9
# Extract gene names as vectors
genes_ALL_Patient_vs_Control <- ALL_Patient_vs_Control$gene
genes_ALL_F.SCR_vs_C.SCR <- ALL_F.SCR_vs_C.SCR$gene
genes_ALL_FXNsh2_vs_C.SCR <- ALL_FXNsh2_vs_C.SCR$gene
genes_ALL_FXNsh3_vs_C.SCR <- ALL_FXNsh3_vs_C.SCR$gene
genes_ALL_FXNsh2_vs_FXNsh3 <- ALL_FXNsh2_vs_FXNsh3$gene
genes_ALL_FXNsh2_vs_F.SCR <- ALL_FXNsh2_vs_F.SCR$gene
genes_ALL_FXNsh3_vs_F.SCR <- ALL_FXNsh3_vs_F.SCR$gene
genes_ALL_FXNsh_vs_F.SCR <- ALL_FXNsh_vs_F.SCR$gene
genes_ALL_FXNsh_vs_C.SCR <- ALL_FXNsh_vs_C.SCR$gene

# Repeat for all lists



```



```{r}

list_of_genes <- list(
  'Patient vs Control [1.4]' = genes_ALL_Patient_vs_Control,
  'F.SCR vs C.SCR [2.4]' = genes_ALL_F.SCR_vs_C.SCR,
  'FXNsh2 vs C.SCR [3.4]' = genes_ALL_FXNsh2_vs_C.SCR,
  'FXNsh3 vs C.SCR [4.4]' = genes_ALL_FXNsh3_vs_C.SCR,
  'FXNsh2 vs FXNsh3 [5.4]' = genes_ALL_FXNsh2_vs_FXNsh3,
  'FXNsh2 vs F.SCR [6.4]' = genes_ALL_FXNsh2_vs_F.SCR,
 'FXNsh3 vs F.SCR [7.4]' = genes_ALL_FXNsh3_vs_F.SCR,
  'FXNsh vs F.SCR [8.4]' = genes_ALL_FXNsh_vs_F.SCR,
  'FXNsh vs C.SCR [9.4]' = genes_ALL_FXNsh_vs_C.SCR
)

```



```{r}
library(ggplot2)
library(UpSetR)
# Define the color vector for the bars outside the upset function
sets.bar.color <- c("#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E", 
                    "#E6AB02","#A6761D","#666666","#3182BD")
# Specify the filename and dimensions and start the PNG device
png(filename = "upset_plot_high_res.png", width = 12, height = 8, units = 'in', res = 300)

# Generate your UpSet plot
upset(fromList(list_of_genes), 
      order.by = "freq", 
      nsets = 9, 
      sets.bar.color = sets.bar.color,
      number.angles = 20, # This sets the text angle to be horizontal
      text.scale = c(1, 1, 1, 1, 1, 1), # Adjust text scaling as needed
      point.size = 1.5, 
      line.size = 0.65,
      mb.ratio = c(0.5, 0.5), # Adjusts the main bar and sets bar sizes if needed
      mainbar.y.label = "DE Genes Intersections",
      sets.x.label = "DE genes per set") 
# Close the device
dev.off()



```





